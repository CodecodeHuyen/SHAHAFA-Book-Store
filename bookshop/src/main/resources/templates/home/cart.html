<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Giỏ hàng - BookShop</title>
    
    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<!-- HEADER -->
<header class="bg-red-600 text-white py-3 shadow">
    <div class="max-w-7xl mx-auto flex items-center justify-between px-4">
        <h1 class="text-2xl font-bold">
            <a th:href="@{/home}" class="hover:opacity-80">
                BookShop
            </a>
        </h1>

        <!-- Search -->
        <form class="flex-1 mx-6" method="get" th:action="@{/home}">
            <input type="text"
                   name="keyword"
                   placeholder="Tìm kiếm sách..."
                   class="w-full p-2 rounded-lg border border-gray-300 text-black" />
        </form>

        <div class="flex gap-6 text-lg">
            <a th:href="@{/cart}" class="hover:opacity-80">Giỏ hàng</a>
            <span>Tài khoản</span>
        </div>
    </div>
</header>

<!-- MAIN CONTENT -->
<div class="max-w-7xl mx-auto mt-6 px-4">

    <!-- Success/Error Messages -->
    <div th:if="${success}" class="mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
        <span th:text="${success}"></span>
    </div>
    <div th:if="${error}" class="mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <span th:text="${error}"></span>
    </div>

    <!-- Cart Title -->
    <h1 class="text-2xl font-bold mb-6">
        GIỎ HÀNG 
        <span th:if="${cart != null and cart.totalItems != null and cart.totalItems > 0}"
              th:text="'(' + ${cart.totalItems} + ' sản phẩm)'">
        </span>
        <span th:if="${cart == null or cart.totalItems == null or cart.totalItems == 0}">
            (0 sản phẩm)
        </span>
    </h1>

    <!-- Empty Cart -->
    <div th:if="${cart == null or cart.items == null or cart.items.isEmpty()}"
         class="bg-white rounded-lg shadow p-12 text-center">
        
        <!-- Empty Cart Icon -->
        <div class="flex justify-center mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-32 w-32 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
        </div>

        <p class="text-gray-600 text-lg mb-6">
            Chưa có sản phẩm trong giỏ hàng của bạn.
        </p>

        <a th:href="@{/home}"
           class="inline-block bg-red-600 text-white px-8 py-3 rounded-lg hover:bg-red-700 font-semibold">
            MUA SẮM NGAY
        </a>
    </div>

    <!-- Cart with Items -->
    <form th:if="${cart != null and cart.items != null and !cart.items.isEmpty()}"
          th:action="@{/api/v1/orders/create-from-cart}" method="post">
        <div class="grid grid-cols-12 gap-6">

            <!-- Cart Items List -->
            <div class="col-span-8 bg-white rounded-lg shadow p-6">
                <table class="w-full">
                    <thead class="border-b-2 border-gray-200">
                        <tr>
                            <th class="text-left pb-4">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" class="w-4 h-4">
                                <label for="selectAll" class="ml-2">Chọn tất cả</label>
                            </th>
                            <th class="text-left pb-4">Sản phẩm</th>
                            <th class="text-center pb-4">Đơn giá</th>
                            <th class="text-center pb-4">Số lượng</th>
                            <th class="text-right pb-4">Thành tiền</th>
                            <th class="text-center pb-4">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="item, itemStat : ${cart.items}" class="border-b border-gray-100" th:id="'cart-item-' + ${item.id}">
                            <td class="py-4 text-center">
                                <input type="checkbox"
                                       class="item-checkbox w-4 h-4"
                                       th:name="'items[' + ${itemStat.index} + '].bookId'"
                                       th:value="${item.bookId}"
                                       onchange="updateSelectedTotal()">
                                <input type="hidden" th:name="'items[' + ${itemStat.index} + '].quantity'" th:value="${item.quantity}">
                            </td>
                            <td class="py-4">
                                <div class="flex items-center gap-4">
                                    <a th:href="@{/books/{id}(id=${item.bookId})}">
                                        <img th:src="${item.bookImage}"
                                             class="w-20 h-28 object-cover rounded"
                                             alt="Book image">
                                    </a>
                                    <div>
                                        <a th:href="@{/books/{id}(id=${item.bookId})}"
                                           class="font-medium text-gray-800 hover:text-red-600"
                                           th:text="${item.bookTitle}">
                                        </a>
                                        <p th:if="${item.quantity > item.availableQuantity}"
                                           class="text-red-600 text-sm mt-1">
                                            Số lượng trong kho chỉ còn <span th:text="${item.availableQuantity}"></span> cuốn
                                        </p>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center py-4">
                                <span class="text-red-600 font-semibold item-unit-price"
                                      th:data-item-id="${item.id}"
                                      th:data-price="${item.bookPrice}"
                                      th:text="${#numbers.formatDecimal(item.bookPrice, 0, 'COMMA', 0, 'POINT') + ' đ'}">
                                </span>
                            </td>
                            <td class="text-center py-4">
                                <div class="flex items-center gap-2">
                                    <input type="number"
                                           th:name="'items[' + ${itemStat.index} + '].quantity'"
                                           th:value="${item.quantity}"
                                           class="w-16 text-center border rounded quantity-input">
                                </div>
                            </td>
                            <td class="text-right py-4">
                                <span class="text-red-600 font-bold item-total"
                                      th:data-item-id="${item.id}"
                                      th:text="${#numbers.formatDecimal(item.subTotal, 0, 'COMMA', 0, 'POINT') + ' đ'}">
                                </span>
                            </td>
                            <td class="text-center py-4">
                                <a th:href="@{/cart/remove(cartItemId=${item.id})}"
                                   class="text-red-600 hover:text-red-800 font-medium"
                                   onclick="return confirm('Bạn có chắc chắn muốn xóa sản phẩm này?')">
                                    Xóa
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Cart Summary -->
            <div class="col-span-4">
                <div class="bg-white rounded-lg shadow p-6 sticky top-4">
                    <h2 class="text-xl font-bold mb-4">Tóm tắt đơn hàng</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Tổng số lượng:</span>
                            <span class="font-semibold" id="selected-items-count">0 sản phẩm</span>
                        </div>

                        <div class="flex justify-between text-lg">
                            <span class="font-bold">Tổng tiền:</span>
                            <span class="text-red-600 font-bold text-xl" id="selected-total">0 đ</span>
                        </div>
                    </div>

                    <a th:href="@{/home}"
                       class="block w-full text-center border border-red-600 text-red-600 py-3 rounded-lg hover:bg-red-50 mb-3">
                        Tiếp tục mua sắm
                    </a>

                    <button type="submit" class="block w-full bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold">
                        Thanh toán
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<br><br>

<script>
    function toggleSelectAll(checkbox) {
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        itemCheckboxes.forEach(cb => {
            cb.checked = checkbox.checked;
        });
        updateSelectedTotal();
    }

    function updateSelectedTotal() {
        const selectedCheckboxes = document.querySelectorAll('.item-checkbox:checked');
        let total = 0;
        let itemCount = 0;

        selectedCheckboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const quantityInput = row.querySelector('.quantity-input');
            const quantity = parseInt(quantityInput.value) || 0;
            const unitPriceElement = row.querySelector('.item-unit-price');
            const unitPrice = parseFloat(unitPriceElement.getAttribute('data-price')) || 0;

            total += unitPrice * quantity;
            itemCount += quantity;
        });

        const totalElement = document.getElementById('selected-total');
        const countElement = document.getElementById('selected-items-count');
        
        if (totalElement) {
            totalElement.textContent = formatCurrency(total) + ' đ';
        }
        
        if (countElement) {
            countElement.textContent = itemCount + ' sản phẩm';
        }
    }

    function formatCurrency(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    document.addEventListener('DOMContentLoaded', function() {
        updateSelectedTotal();
    });
</script>

</body>
</html>
